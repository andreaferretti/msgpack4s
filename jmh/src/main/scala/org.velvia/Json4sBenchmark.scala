package org.velvia

import org.openjdk.jmh.annotations.Benchmark
import org.openjdk.jmh.annotations.BenchmarkMode
import org.openjdk.jmh.annotations.{Mode, State, Scope}
import org.openjdk.jmh.annotations.OutputTimeUnit
import util.Random

import java.util.concurrent.TimeUnit

/**
 * Measures serialization speeds for Json4S AST, JSON vs msgpack4s, using a GeoJSON-based example
 * Obviously this is meant to highlight an advantage for msgpack4s.  See the Rojoma benchmark
 * for a more common JSON example.
 *
 * For a description of the JMH measurement modes, see
 * https://github.com/ktoso/sbt-jmh/blob/master/src/sbt-test/sbt-jmh/jmh-run/src/main/scala/org/openjdk/jmh/samples/JMHSample_02_BenchmarkModes.scala
 */
@State(Scope.Thread)
class Json4sBenchmark {
  // From City of Chicago GeoJSON
  val geoJsonStr = """
{"type":"Feature","geometry":{"type":"MultiPolygon","coordinates":[[[[-122.419224000303,37.8084529988503],[-122.419209999933,37.8083879987715],[-122.419086000307,37.8078029987107],[-122.41890800035,37.8068629993342],[-122.418781999832,37.8062409988176],[-122.418380999904,37.8059769991614],[-122.417226000312,37.8051699988847],[-122.416818000394,37.8048869994474],[-122.416696000492,37.8042769990165],[-122.416605000011,37.8038229991133],[-122.416510999499,37.8033479991638],[-122.416323999798,37.8024109989096],[-122.417965999793,37.8022009988738],[-122.417877000219,37.8017069992708],[-122.417798999763,37.8012669989059],[-122.416663000154,37.8014129990293],[-122.416133000089,37.8014809989957],[-122.416038000462,37.8010129991899],[-122.415943000256,37.8005469990861],[-122.415863999599,37.8001419988723],[-122.415761999512,37.7996159987249],[-122.416491000306,37.7995249990543],[-122.417385000124,37.7994139989871],[-122.417480999887,37.7994009989596],[-122.41822599992,37.7993049987749],[-122.419048999584,37.7991979986564],[-122.419961000145,37.7990849989214],[-122.420086000365,37.7990689993906],[-122.420345999847,37.7990369993177],[-122.420579999694,37.7990079986842],[-122.420688999905,37.7989709994636],[-122.422337000473,37.7987619991301],[-122.423981999868,37.7985519989933],[-122.423861000083,37.798471998645],[-122.423708999928,37.7977229989347],[-122.423793000159,37.7976169993813],[-122.423672000058,37.7975359994118],[-122.423599000042,37.797178998943],[-122.42352099958,37.7967929986915],[-122.42360100042,37.7966909991849],[-122.423483999513,37.7966059990962],[-122.423333000076,37.7958599988102],[-122.423413000187,37.7957369993079],[-122.42349300001,37.7956139988478],[-122.423347999475,37.7948969990462],[-122.42322699954,37.7948169990056],[-122.423311000554,37.7947109987824],[-122.423169999934,37.7940149993583],[-122.423049000492,37.7939349991406],[-122.423132999628,37.7938289990457],[-122.422993000132,37.793129999101],[-122.422870999532,37.7930499988197],[-122.422955000191,37.7929439987974],[-122.422816000046,37.792254999293],[-122.422693999938,37.7921749988344],[-122.422778000101,37.7920679994696],[-122.422635999458,37.7913689991735],[-122.422515000385,37.7912889993441],
 [-122.422598999561,37.7911829995412],[-122.422454999551,37.7904719994434],[-122.422329000257,37.7903699993831],[-122.422203000399,37.7902669988519],[-122.422052000247,37.7895179990498],[-122.422134999856,37.7894119986923],[-122.422013999994,37.7893319992953],[-122.421939999979,37.7889689991135],[-122.421865000341,37.7885959990568],[-122.421948999645,37.7884899987272],[-122.421826999892,37.7884099992294],[-122.421749999473,37.7880269993593],[-122.421674000157,37.7876539992202],[-122.421757999804,37.78754799899],[-122.421636999979,37.7874679992346],[-122.421559999892,37.7870869989993],[-122.421484000221,37.7867139987112],[-122.421569999558,37.7866189986795],[-122.423213999894,37.7864019993457],[-122.423028000164,37.785481999374],[-122.423547999843,37.7854099991388],[-122.423820000059,37.7853809994596],[-122.424441000297,37.7853959989632],[-122.424559000435,37.7854049992196],[-122.424687000192,37.7853349994892],[-122.424858000364,37.7861959988031],[-122.425047000517,37.7871299989474],[-122.425141000462,37.7875969993815],[-122.42523700019,37.7880699989081],[-122.425331000431,37.7885359987952],[-122.425422999987,37.788994999068],[-122.427059999649,37.7887869994699],[-122.427259999468,37.7897429989565],[-122.428905000317,37.7895339987381],[-122.430550999934,37.7893239992641],[-122.430355999649,37.7883679993638],[-122.432002999712,37.788158999109],[-122.432826000184,37.7880549986607],[-122.433646999951,37.7879499987527],[-122.435293000415,37.7877409992626],[-122.436934999447,37.7875329994664],[-122.438582000057,37.7873249989537],[-122.438394000529,37.786391998938],[-122.436746999668,37.7866009993508],[-122.43510599953,37.7868109992292],[-122.434917999813,37.7858759990286],[-122.436557000391,37.7856679989008],[-122.438206000072,37.7854589994592],[-122.439872999773,37.7852479989634],[-122.441536999578,37.7850359994511],[-122.443183000148,37.7848269991394],[-122.444830999636,37.7846169991396],[-122.446246999773,37.7844379993583],[-122.446032999705,37.7835089995015],[-122.444642999893,37.7836859991523],[-122.442989000039,37.7838969988009],[-122.441349000497,37.7841069992481],[-122.441255000434,37.7836419988363],[-122.441158000102,37.7831639989596],
 [-122.44112999985,37.7830299988013],[-122.440962999994,37.7822389993173],[-122.440784000371,37.7813099994215],[-122.440589000548,37.7803729992522],[-122.440396999909,37.7794389990516],[-122.440957999616,37.7793639994193],[-122.441119000517,37.7793719992517],[-122.442053000085,37.7792439987032],[-122.443698999537,37.7790379989305],[-122.445346999464,37.778836998866],[-122.446035000084,37.778749999083],[-122.447040000184,37.7786219988612],[-122.447016999541,37.7787259994541],[-122.447289000534,37.7800619991812],[-122.447352000475,37.780151999121],[-122.447322999472,37.7802409988826],[-122.447444999881,37.7810119987019],[-122.447517999958,37.7810699995052],[-122.447466999865,37.7811599989498],[-122.447539000439,37.7815099995216],[-122.447501999482,37.7816939994686],[-122.447311000291,37.7821829994228],[-122.447302000455,37.7823919989871],[-122.447317999456,37.7824319995127],[-122.447366000241,37.7825549993786],[-122.448064000198,37.7824829988538],[-122.448989000557,37.7823599988332],[-122.449078999807,37.7823139987406],[-122.450025999899,37.7822029987946],[-122.450092000529,37.7821169993655],[-122.450199000054,37.7821769992476],[-122.451045999616,37.7820729993392],[-122.45112000039,37.7819839992283],[-122.45123300055,37.7820509987078],[-122.452061000434,37.7819469994933],[-122.452142999782,37.7818529987761],[-122.452252000261,37.7819129988348],[-122.453099000048,37.7818029990518],[-122.453169999812,37.7817169988255],[-122.453268000559,37.7817789988554],[-122.454069999762,37.7816859992635],[-122.454175999923,37.7815989992197],[-122.454283000178,37.7816549994079],[-122.455211000208,37.7815359992582],[-122.455280999983,37.7814589994935],[-122.455378000184,37.781523999242],[-122.455469000415,37.781513999482],[-122.455523999804,37.7814309992867],[-122.455632999994,37.781489999511],[-122.456225999696,37.781453998919],[-122.456296000392,37.7813809990483],[-122.456396000486,37.7814469990214],[-122.456628999639,37.7814389993181],[-122.457647000354,37.7813959986357],[-122.457733000229,37.7813149988177],[-122.457822999979,37.7813759987488],[-122.458730000288,37.7813429988535],[-122.458859000048,37.7812569993584]
 ]]]},"properties":{"supdist":"SUPERVISORIAL DISTRICT 2"
,"supname":"Farrell","supervisor":"2","numbertext":"TWO","_feature_id":"1","_feature_id_string":"Elect_Super
visor_Dists.1"}
}
  """

  import org.json4s.native.JsonMethods._
  import org.json4s._

  val ast = parse(geoJsonStr)
  val os = new org.apache.commons.io.output.NullOutputStream
  val dos = new java.io.DataOutputStream(os)

  import org.velvia.msgpack.Json4sCodecs._

  @Benchmark
  @BenchmarkMode(Array(Mode.AverageTime))
  @OutputTimeUnit(TimeUnit.MICROSECONDS)
  def json4sAstMsgpack(): Int = {
    var total = 0
    while (total < 100) {
      msgpack.pack(ast, dos)
      dos.flush()
      total += 1
    }
    total
  }

  @Benchmark
  @BenchmarkMode(Array(Mode.AverageTime))
  @OutputTimeUnit(TimeUnit.MICROSECONDS)
  def json4sAstJson(): Int = {
    var total = 0
    while (total < 100) {
      dos.write(compact(render(ast)).getBytes("UTF-8"))
      total += 1
    }
    total
  }
}
